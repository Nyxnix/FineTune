name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-26
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install create-dmg dependencies
        run: brew install graphicsmagick imagemagick

      - name: Import signing certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain"

          # Decode certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate to keychain
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Allow codesign to access the certificate
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Add keychain to search list (prepend to ensure it's found first)
          security list-keychain -d user -s "$KEYCHAIN_PATH" $(security list-keychain -d user | tr -d '"')

          # Verify certificate is available
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Update ExportOptions with Team ID
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          sed -i '' "s/TEAM_ID_PLACEHOLDER/$APPLE_TEAM_ID/g" ExportOptions.plist
          cat ExportOptions.plist

      - name: Build archive
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcodebuild -project FineTune.xcodeproj \
            -scheme FineTune \
            -configuration Release \
            -archivePath build/FineTune.xcarchive \
            archive \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID"

      - name: Export archive
        run: |
          xcodebuild -exportArchive \
            -archivePath build/FineTune.xcarchive \
            -exportPath build/ \
            -exportOptionsPlist ExportOptions.plist

          # Verify the app is signed
          codesign -dv --verbose=4 build/FineTune.app

      - name: Create DMG
        run: |
          # create-dmg creates a nicely formatted DMG with Applications symlink
          npx create-dmg build/FineTune.app build/ --overwrite || true

          # Rename to include version from tag
          VERSION=${GITHUB_REF_NAME#v}
          DMG_NAME="FineTune-${VERSION}.dmg"

          # Find and rename the created DMG (create-dmg names it "AppName Version.dmg")
          mv build/*.dmg "build/${DMG_NAME}"

          echo "DMG_NAME=${DMG_NAME}" >> $GITHUB_ENV
          echo "Created: build/${DMG_NAME}"

      - name: Sign DMG
        env:
          CERT_IDENTITY: ${{ secrets.CERT_IDENTITY }}
        run: |
          # Sign the DMG with Developer ID
          codesign --force --sign "$CERT_IDENTITY" "build/$DMG_NAME"

          # Verify signature
          codesign -dv --verbose=2 "build/$DMG_NAME"

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Submit DMG for notarization and wait for result
          xcrun notarytool submit "build/$DMG_NAME" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Staple the notarization ticket to the DMG
          xcrun stapler staple "build/$DMG_NAME"

          # Verify stapling
          xcrun stapler validate "build/$DMG_NAME"

      - name: Sign DMG for Sparkle and update appcast
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          DMG_PATH="build/$DMG_NAME"

          # Download Sparkle tools
          SPARKLE_VERSION="2.8.1"
          curl -L -o sparkle.tar.xz "https://github.com/sparkle-project/Sparkle/releases/download/${SPARKLE_VERSION}/Sparkle-${SPARKLE_VERSION}.tar.xz"
          mkdir -p sparkle_tools
          tar -xf sparkle.tar.xz -C sparkle_tools

          # Get DMG size
          DMG_SIZE=$(stat -f%z "$DMG_PATH")

          # Sign DMG with EdDSA key
          ED_SIGNATURE=$(echo -n "$SPARKLE_PRIVATE_KEY" | sparkle_tools/bin/sign_update "$DMG_PATH")

          # Get current date in RFC 2822 format
          PUB_DATE=$(date -R)

          # Create new item entry
          NEW_ITEM=$(cat <<EOF
    <item>
      <title>Version ${VERSION}</title>
      <sparkle:version>${VERSION}</sparkle:version>
      <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
      <pubDate>${PUB_DATE}</pubDate>
      <enclosure
        url="https://github.com/ronitsingh10/FineTune/releases/download/v${VERSION}/FineTune-${VERSION}.dmg"
        sparkle:edSignature="${ED_SIGNATURE}"
        length="${DMG_SIZE}"
        type="application/octet-stream"/>
      <sparkle:minimumSystemVersion>15.0</sparkle:minimumSystemVersion>
    </item>
EOF
          )

          # Insert new item after the comment block in appcast.xml
          # Using awk to insert after the closing comment
          awk -v item="$NEW_ITEM" '
            /^[[:space:]]*-->/ && !inserted {
              print
              print item
              inserted=1
              next
            }
            {print}
          ' appcast.xml > appcast_new.xml
          mv appcast_new.xml appcast.xml

          echo "Updated appcast.xml with version ${VERSION}"
          cat appcast.xml

      - name: Commit updated appcast
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add appcast.xml
          git commit -m "Update appcast for ${GITHUB_REF_NAME}" || echo "No changes to commit"
          git push origin HEAD:main

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/FineTune-*.dmg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
